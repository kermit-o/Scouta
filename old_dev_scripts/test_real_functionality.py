#!/usr/bin/env python3
import os
import sys
import shutil
import time

def test_real_functionality():
    """Test que realmente ejecuta el proyecto generado"""
    print("üéØ FORGE SAAS - TEST DE FUNCIONALIDAD REAL")
    print("===========================================")
    
    # Limpiar proyecto anterior
    test_project = "generated_projects/Real Functionality Test"
    if os.path.exists(test_project):
        shutil.rmtree(test_project)
    
    try:
        # 1. Generar proyecto
        print("\\n1. üöÄ GENERANDO PROYECTO...")
        from generators.simple_engine import SimpleTemplateEngine
        
        engine = SimpleTemplateEngine()
        result = engine.generate_react_project(
            "Real Functionality Test",
            "Proyecto para test de funcionalidad real",
            validate=False  # No validar para evitar problemas con Node.js
        )
        
        if not result["success"]:
            print("‚ùå FALL√ì la generaci√≥n del proyecto")
            return False
        
        project_path = result["project_path"]
        print(f"‚úÖ Proyecto generado: {project_path}")
        
        # 2. Verificar archivos manualmente
        print("\\n2. üîç VERIFICACI√ìN MANUAL DE ARCHIVOS...")
        
        required_files = {
            "package.json": "Debe contener scripts y dependencias",
            "src/App.jsx": "Componente principal de React", 
            "src/main.jsx": "Punto de entrada de la aplicaci√≥n",
            "index.html": "HTML base",
            "vite.config.js": "Configuraci√≥n de Vite"
        }
        
        all_files_ok = True
        for file, description in required_files.items():
            file_path = os.path.join(project_path, file)
            if os.path.exists(file_path):
                size = os.path.getsize(file_path)
                print(f"   ‚úÖ {file}: {size} bytes - {description}")
                
                # Verificar contenido b√°sico
                if size == 0:
                    print(f"      ‚ö†Ô∏è  Archivo vac√≠o")
                    all_files_ok = False
            else:
                print(f"   ‚ùå {file}: NO EXISTE - {description}")
                all_files_ok = False
        
        if not all_files_ok:
            print("‚ùå Faltan archivos cr√≠ticos")
            return False
        
        # 3. Probar instalaci√≥n de dependencias
        print("\\n3. üì¶ INSTALANDO DEPENDENCIAS...")
        try:
            import subprocess
            install_result = subprocess.run(
                ['npm', 'install'],
                cwd=project_path,
                capture_output=True,
                text=True,
                timeout=120
            )
            
            if install_result.returncode == 0:
                print("‚úÖ Dependencias instaladas correctamente")
            else:
                print(f"‚ùå Error instalando dependencias: {install_result.stderr[:200]}")
                return False
                
        except subprocess.TimeoutExpired:
            print("‚ùå Timeout instalando dependencias")
            return False
        except Exception as e:
            print(f"‚ùå Error durante instalaci√≥n: {str(e)}")
            return False
        
        # 4. Probar build
        print("\\n4. üî® PROBANDO BUILD...")
        try:
            build_result = subprocess.run(
                ['npm', 'run', 'build'],
                cwd=project_path,
                capture_output=True,
                text=True,
                timeout=60
            )
            
            if build_result.returncode == 0:
                print("‚úÖ Build exitoso")
                
                # Verificar que se cre√≥ el directorio dist
                dist_path = os.path.join(project_path, "dist")
                if os.path.exists(dist_path):
                    print("‚úÖ Directorio dist creado")
                    
                    # Contar archivos en dist
                    dist_files = []
                    for root, dirs, files in os.walk(dist_path):
                        for file in files:
                            dist_files.append(os.path.join(root, file))
                    
                    print(f"‚úÖ {len(dist_files)} archivos generados en dist/")
                    return True
                else:
                    print("‚ùå Directorio dist no creado")
                    return False
            else:
                print(f"‚ùå Build fall√≥: {build_result.stderr[:200]}")
                return False
                
        except subprocess.TimeoutExpired:
            print("‚ùå Timeout en build")
            return False
        except Exception as e:
            print(f"‚ùå Error durante build: {str(e)}")
            return False
            
    except Exception as e:
        print(f"‚ùå ERROR EN EL TEST: {str(e)}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    success = test_real_functionality()
    
    print("\\n" + "="*50)
    if success:
        print("üéâ ¬°TEST DE FUNCIONALIDAD EXITOSO!")
        print("üöÄ Forge SaaS genera proyectos React COMPLETAMENTE FUNCIONALES")
        print("üì¶ Los proyectos pueden instalar dependencias y compilar correctamente")
    else:
        print("üí• EL TEST DE FUNCIONALIDAD FALL√ì")
        print("üîß Revisa los errores espec√≠ficos")
    
    sys.exit(0 if success else 1)
