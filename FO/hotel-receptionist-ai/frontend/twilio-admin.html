<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n Twilio - Hotel Receptionist AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">
                <i class="fas fa-cog text-blue-500"></i> Configuraci√≥n Twilio
            </h1>
            <p class="text-gray-600">Configuraci√≥n de telefon√≠a y SMS automatizados</p>
        </header>

        <!-- Back to Dashboard -->
        <div class="mb-6">
            <a href="/" class="inline-flex items-center gap-2 text-blue-600 hover:text-blue-800">
                <i class="fas fa-arrow-left"></i>
                Volver al Dashboard
            </a>
        </div>

        <!-- Twilio Status Card -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-signal text-green-500 mr-2"></i>Estado de Twilio
            </h2>
            <div id="twilio-status" class="space-y-4">
                <p class="text-gray-500">Cargando estado de Twilio...</p>
            </div>
        </div>

        <!-- Configuration Form -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: Configuration -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-key text-yellow-500 mr-2"></i>Configurar Credenciales
                </h2>
                
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <h3 class="font-bold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>¬øC√≥mo obtener credenciales?
                    </h3>
                    <ol class="list-decimal pl-5 space-y-2 text-blue-700">
                        <li>Ve a <a href="https://www.twilio.com/try-twilio" target="_blank" class="underline font-medium">twilio.com/try-twilio</a></li>
                        <li>Reg√≠strate con tu email (gratis, incluye cr√©dito)</li>
                        <li>Verifica tu n√∫mero de tel√©fono</li>
                        <li>En el Dashboard, copia:
                            <ul class="list-disc pl-5 mt-2">
                                <li>ACCOUNT SID</li>
                                <li>AUTH TOKEN</li>
                                <li>N√∫mero de tel√©fono Twilio</li>
                            </ul>
                        </li>
                    </ol>
                </div>

                <form id="twilio-config-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Account SID
                        </label>
                        <input type="text" id="account-sid" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Auth Token
                        </label>
                        <input type="password" id="auth-token"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Tu auth token secreto">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            N√∫mero Twilio
                        </label>
                        <input type="text" id="phone-number"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               placeholder="+15005550006">
                        <p class="text-sm text-gray-500 mt-1">
                            Usa <code class="bg-gray-100 px-1">+15005550006</code> para pruebas
                        </p>
                    </div>
                    
                    <div class="pt-4">
                        <button type="submit" 
                                class="w-full bg-blue-500 text-white py-3 px-4 rounded-lg hover:bg-blue-600 transition font-medium">
                            <i class="fas fa-save mr-2"></i>Guardar Configuraci√≥n
                        </button>
                    </div>
                </form>
            </div>

            <!-- Right Column: Test Functions -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-vial text-purple-500 mr-2"></i>Probar Funcionalidades
                </h2>
                
                <!-- Test SMS -->
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-3">Probar SMS</h3>
                    <div class="flex gap-2">
                        <input type="text" id="test-phone" 
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                               placeholder="+34600123456"
                               value="+15005550001">
                        <button onclick="testSMS()" 
                                class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                            <i class="fas fa-sms"></i> Enviar SMS
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        Usa <code class="bg-gray-100 px-1">+15005550001</code> (Magic Test Number)
                    </p>
                </div>
                
                <!-- Test Call -->
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-3">Probar Llamada</h3>
                    <div class="flex gap-2">
                        <input type="text" id="test-call-phone"
                               class="flex-1 px-4 py-2 border border-gray-300 rounded-lg"
                               placeholder="+34600123456"
                               value="+15005550001">
                        <button onclick="testCall()" 
                                class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition">
                            <i class="fas fa-phone"></i> Llamar
                        </button>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">
                        N√∫meros de prueba de Twilio funcionan incluso sin cr√©dito
                    </p>
                </div>
                
                <!-- Get Numbers -->
                <div class="mb-6">
                    <h3 class="font-medium text-gray-700 mb-3">N√∫meros Disponibles</h3>
                    <button onclick="getPhoneNumbers()" 
                            class="w-full bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition">
                        <i class="fas fa-list mr-2"></i>Ver N√∫meros Twilio
                    </button>
                    <div id="phone-numbers-list" class="mt-3 space-y-2 max-h-40 overflow-y-auto">
                        <!-- Numbers will appear here -->
                    </div>
                </div>
                
                <!-- Quick Guide -->
                <div class="p-4 bg-yellow-50 rounded-lg">
                    <h4 class="font-bold text-yellow-800 mb-2">
                        <i class="fas fa-lightbulb mr-2"></i>Gu√≠a R√°pida
                    </h4>
                    <ul class="text-sm text-yellow-700 space-y-1">
                        <li>‚úÖ Twilio Sandbox funciona sin tarjeta de cr√©dito</li>
                        <li>üî¢ N√∫meros que empiezan con +1500555... son para pruebas</li>
                        <li>üí≥ Para n√∫meros reales, necesitas verificar tu cuenta</li>
                        <li>üìû Las llamadas de prueba no consumen cr√©dito real</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Results Log -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">
                <i class="fas fa-terminal text-gray-500 mr-2"></i>Log de Resultados
            </h2>
            <div id="results-log" class="bg-gray-50 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm">
                <!-- Results will appear here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        
        // Funci√≥n para cargar estado de Twilio
        async function loadTwilioStatus() {
            try {
                const response = await fetch(`${API_BASE}/api/v1/twilio/status`);
                const data = await response.json();
                
                let statusHtml = '';
                
                if (data.configured) {
                    statusHtml = `
                        <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
                            <div>
                                <h3 class="font-bold text-green-800">‚úÖ Twilio Configurado</h3>
                                <p class="text-green-700">N√∫mero: ${data.phone_number || 'No configurado'}</p>
                            </div>
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                                <i class="fas fa-check mr-1"></i>Operativo
                            </span>
                        </div>
                    `;
                } else {
                    statusHtml = `
                        <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg">
                            <div>
                                <h3 class="font-bold text-yellow-800">‚ö†Ô∏è Twilio No Configurado</h3>
                                <p class="text-yellow-700">${data.message}</p>
                            </div>
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Pendiente
                            </span>
                        </div>
                        
                        <div class="p-4 bg-blue-50 rounded-lg mt-4">
                            <h4 class="font-bold text-blue-800 mb-2">Pasos para configurar:</h4>
                            <ol class="list-decimal pl-5 space-y-1 text-blue-700">
                                <li>Reg√≠strate en <a href="https://www.twilio.com/try-twilio" target="_blank" class="underline font-medium">Twilio</a> (gratis)</li>
                                <li>Copia tus credenciales del Dashboard</li>
                                <li>P√©galas en el formulario de la derecha</li>
                                <li>¬°Listo para recibir llamadas reales!</li>
                            </ol>
                        </div>
                    `;
                }
                
                document.getElementById('twilio-status').innerHTML = statusHtml;
                
            } catch (error) {
                console.error('Error loading Twilio status:', error);
                document.getElementById('twilio-status').innerHTML = `
                    <div class="p-4 bg-red-50 rounded-lg">
                        <p class="text-red-700">‚ùå Error cargando estado de Twilio</p>
                    </div>
                `;
            }
        }
        
        // Funci√≥n para guardar configuraci√≥n
        document.getElementById('twilio-config-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const accountSid = document.getElementById('account-sid').value.trim();
            const authToken = document.getElementById('auth-token').value.trim();
            const phoneNumber = document.getElementById('phone-number').value.trim();
            
            if (!accountSid || !authToken || !phoneNumber) {
                addToLog('‚ùå Por favor completa todos los campos', 'error');
                return;
            }
            
            addToLog('‚öôÔ∏è Guardando configuraci√≥n de Twilio...', 'info');
            
            // En una app real, enviar√≠as esto al backend
            // Por ahora, solo mostramos mensaje
            addToLog(`‚úÖ Configuraci√≥n guardada (simulado):
   Account SID: ${accountSid.substring(0, 10)}...
   Phone: ${phoneNumber}
   
   ‚ö†Ô∏è En producci√≥n, guarda esto en el archivo .env:
   
   TWILIO_ACCOUNT_SID=${accountSid}
   TWILIO_AUTH_TOKEN=${authToken}
   TWILIO_PHONE_NUMBER=${phoneNumber}`, 'success');
            
            // Recargar estado
            setTimeout(loadTwilioStatus, 1000);
        });
        
        // Funci√≥n para probar SMS
        async function testSMS() {
            const phone = document.getElementById('test-phone').value.trim();
            
            if (!phone) {
                addToLog('‚ùå Ingresa un n√∫mero de tel√©fono', 'error');
                return;
            }
            
            addToLog(`üì± Enviando SMS a ${phone}...`, 'info');
            
            try {
                const response = await fetch(
                    `${API_BASE}/api/v1/twilio/send-sms?to=${encodeURIComponent(phone)}&message=Hola desde Hotel Receptionist AI! Mensaje de prueba del sistema automatizado.`,
                    { method: 'POST' }
                );
                
                const data = await response.json();
                
                if (data.success) {
                    addToLog(`‚úÖ SMS enviado exitosamente:
   ID: ${data.data.sid}
   Estado: ${data.data.status}
   Para: ${data.data.to}`, 'success');
                } else {
                    addToLog(`‚ùå Error enviando SMS: ${data.detail || 'Error desconocido'}`, 'error');
                }
                
            } catch (error) {
                addToLog(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }
        
        // Funci√≥n para probar llamada
        async function testCall() {
            const phone = document.getElementById('test-call-phone').value.trim();
            
            if (!phone) {
                addToLog('‚ùå Ingresa un n√∫mero de tel√©fono', 'error');
                return;
            }
            
            addToLog(`üìû Llamando a ${phone}...`, 'info');
            
            try {
                const response = await fetch(
                    `${API_BASE}/api/v1/twilio/make-call?to=${encodeURIComponent(phone)}`,
                    { method: 'POST' }
                );
                
                const data = await response.json();
                
                if (data.success) {
                    addToLog(`‚úÖ Llamada iniciada exitosamente:
   ID: ${data.data.sid}
   Estado: ${data.data.status}
   Para: ${data.data.to}
   
   ‚ö†Ô∏è Si usas +15005550001 (Magic Number), sonar√° pero no se conectar√°.
   ‚ö†Ô∏è Para pruebas reales, usa tu propio n√∫mero verificado.`, 'success');
                } else {
                    addToLog(`‚ùå Error iniciando llamada: ${data.detail || 'Error desconocido'}`, 'error');
                }
                
            } catch (error) {
                addToLog(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }
        
        // Funci√≥n para obtener n√∫meros disponibles
        async function getPhoneNumbers() {
            addToLog('üìã Obteniendo n√∫meros Twilio disponibles...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/v1/twilio/numbers`);
                const data = await response.json();
                
                if (data.numbers && data.numbers.length > 0) {
                    let numbersHtml = '<div class="space-y-2">';
                    
                    data.numbers.forEach(num => {
                        numbersHtml += `
                            <div class="p-2 border rounded hover:bg-gray-50">
                                <div class="font-medium">${num.phone_number}</div>
                                <div class="text-sm text-gray-500">${num.friendly_name || 'Sin nombre'}</div>
                            </div>
                        `;
                    });
                    
                    numbersHtml += '</div>';
                    
                    document.getElementById('phone-numbers-list').innerHTML = numbersHtml;
                    
                    addToLog(`‚úÖ Encontrados ${data.count} n√∫meros Twilio`, 'success');
                } else {
                    document.getElementById('phone-numbers-list').innerHTML = `
                        <p class="text-gray-500">No hay n√∫meros disponibles</p>
                    `;
                    addToLog('‚ÑπÔ∏è No hay n√∫meros Twilio en esta cuenta', 'info');
                }
                
            } catch (error) {
                addToLog(`‚ùå Error obteniendo n√∫meros: ${error.message}`, 'error');
            }
        }
        
        // Funci√≥n para agregar al log
        function addToLog(message, type = 'info') {
            const logDiv = document.getElementById('results-log');
            const timestamp = new Date().toLocaleTimeString('es-ES', {hour12: false});
            
            const colorClass = {
                'info': 'text-blue-600',
                'success': 'text-green-600',
                'error': 'text-red-600',
                'warning': 'text-yellow-600'
            }[type] || 'text-gray-600';
            
            const entry = document.createElement('div');
            entry.className = `mb-2 ${colorClass}`;
            entry.innerHTML = `<span class="text-gray-400">[${timestamp}]</span> ${message}`;
            
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Cargar estado al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            loadTwilioStatus();
            addToLog('üöÄ Panel de configuraci√≥n Twilio iniciado', 'info');
            addToLog('üí° Usa n√∫meros que empiecen con +1500555 para pruebas sin cr√©dito', 'info');
        });
    </script>
</body>
</html>
