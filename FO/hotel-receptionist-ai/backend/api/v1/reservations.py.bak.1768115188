"""
Endpoints para gestión de reservas - Versión 1
"""
from fastapi import APIRouter, HTTPException, Query
from typing import Optional
from datetime import date
import logging

from backend.services.reservation_service import ReservationService

router = APIRouter(prefix="/api/v1/reservations", tags=["reservations"])
logger = logging.getLogger(__name__)

@router.get("/availability")
async def check_availability(
    check_in: date,
    check_out: date,
    room_type: Optional[str] = Query(None, description="Tipo de habitación")
):
    """
    Verificar disponibilidad de habitaciones
    
    - **check_in**: Fecha de entrada (YYYY-MM-DD)
    - **check_out**: Fecha de salida (YYYY-MM-DD)
    - **room_type**: (Opcional) Tipo de habitación (standard, deluxe, suite)
    """
    try:
        if check_in >= check_out:
            raise HTTPException(
                status_code=400,
                detail="La fecha de entrada debe ser anterior a la de salida"
            )
        
        if (check_out - check_in).days > 30:
            raise HTTPException(
                status_code=400,
                detail="La estadía máxima es de 30 días"
            )
        
        availability = await ReservationService.check_availability(
            check_in, check_out, room_type
        )
        
        return {
            "success": True,
            "data": availability
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error verificando disponibilidad: {e}")
        raise HTTPException(status_code=500, detail="Error interno del servidor")

@router.post("/")
async def create_reservation(reservation: dict):
    """
    Crear una nueva reserva
    
    Ejemplo de datos:
    ```json
    {
        "guest_name": "Juan Pérez",
        "guest_email": "juan@example.com",
        "guest_phone": "+34600123456",
        "check_in": "2024-01-10",
        "check_out": "2024-01-15",
        "room_type": "standard",
        "number_of_guests": 2,
        "special_requests": "Habitación no fumadores"
    }
    ```
    """
    try:
        # Validaciones básicas
        required_fields = ["guest_name", "guest_email", "check_in", "check_out", "room_type"]
        for field in required_fields:
            if field not in reservation:
                raise HTTPException(
                    status_code=400,
                    detail=f"Campo requerido faltante: {field}"
                )
        
        # Crear reserva
        result = await ReservationService.create_reservation(reservation)
        
        return {
            "success": True,
            "message": "Reserva creada exitosamente",
            "data": result
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error creando reserva: {e}")
        raise HTTPException(status_code=500, detail="Error interno del servidor")

@router.get("/{reservation_id}")
async def get_reservation(reservation_id: str):
    """Obtener información de una reserva específica"""
    try:
        reservation = await ReservationService.get_reservation(reservation_id)
        
        if not reservation:
            raise HTTPException(
                status_code=404,
                detail=f"Reserva no encontrada: {reservation_id}"
            )
        
        return {
            "success": True,
            "data": reservation
        }
        
    except HTTPException:
        raise
    except Exception as e:
        logger.error(f"Error obteniendo reserva: {e}")
        raise HTTPException(status_code=500, detail="Error interno del servidor")

@router.get("/")
async def list_reservations(
    status: Optional[str] = Query(None, description="Filtrar por estado"),
    limit: int = Query(50, ge=1, le=100, description="Límite de resultados")
):
    """Listar reservas (simulado para ahora)"""
    # Por ahora devolvemos datos simulados
    return {
        "success": True,
        "data": {
            "reservations": [],
            "total": 0,
            "limit": limit,
            "status_filter": status
        },
        "message": "Endpoint en desarrollo. Próximamente con datos reales de BD."
    }
