"""
DietAI API - Versi칩n Mejorada
Mantiene compatibilidad con endpoints existentes pero agrega:
1. Mejor logging
2. Estructura para expansi칩n
3. Preparaci칩n para base de datos
"""
import logging
from fastapi import FastAPI, HTTPException, Depends
from pydantic import BaseModel
from typing import Optional, List
from datetime import datetime
import sys
import os

# Configurar logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# Crear aplicaci칩n
app = FastAPI(
    title="DietAI API Mejorada",
    version="2.1.0",
    description="API inteligente para gesti칩n de dietas - Versi칩n mejorada"
)

# Modelos (compatibles con versi칩n anterior)
class User(BaseModel):
    email: str
    username: str
    password: str

class DietRequest(BaseModel):
    age: int
    gender: str
    height: float
    weight: float
    activity: str = "moderate"
    goal: str = "weight_loss"

# ================= ENDPOINTS EXISTENTES (MANTENER COMPATIBILIDAD) =================
@app.get("/")
async def root():
    """Endpoint ra칤z - Mejorado con logging"""
    logger.info("Acceso a endpoint ra칤z")
    return {
        "message": "DietAI API Mejorada",
        "timestamp": datetime.utcnow().isoformat(),
        "status": "online",
        "version": "2.1.0",
        "features": [
            "Generaci칩n de dietas personalizadas",
            "An치lisis de im치genes (pr칩ximamente)",
            "Gesti칩n de inventario (pr칩ximamente)",
            "Base de datos PostgreSQL (pr칩ximamente)"
        ]
    }

@app.get("/health")
async def health():
    """Health check mejorado"""
    health_status = {
        "status": "healthy",
        "timestamp": datetime.utcnow().isoformat(),
        "service": "dietai-api",
        "version": "2.1.0",
        "database": "postgresql://localhost:5432/dietai (simulado)",
        "uptime": "running"
    }
    logger.info(f"Health check: {health_status}")
    return health_status

@app.get("/test")
async def test():
    """Endpoint de prueba"""
    return {"test": "ok", "python_version": sys.version}

@app.post("/auth/register")
async def register(email: str, username: str, password: str):
    """Registro mejorado con logging"""
    logger.info(f"Intento de registro: {email}, {username}")
    
    # Simulaci칩n de validaci칩n
    if len(password) < 6:
        logger.warning(f"Contrase침a muy corta para {email}")
        raise HTTPException(status_code=400, detail="La contrase침a debe tener al menos 6 caracteres")
    
    return {
        "message": "Usuario registrado exitosamente",
        "user": {
            "email": email,
            "username": username,
            "id": 1,
            "created_at": datetime.utcnow().isoformat()
        },
        "next_steps": [
            "Completar perfil en /profile/create",
            "Generar primera dieta en /diets/generate"
        ]
    }

@app.post("/diets/generate")
async def generate_diet(
    age: int,
    gender: str,
    height: float,
    weight: float,
    activity: str = "moderate",
    goal: str = "weight_loss"
):
    """Generador de dietas mejorado"""
    logger.info(f"Generando dieta para: {age}a침os, {gender}, {height}cm, {weight}kg, {activity}, {goal}")
    
    # C치lculo mejorado
    if gender.lower() == "male":
        bmr = 10 * weight + 6.25 * height - 5 * age + 5
    else:
        bmr = 10 * weight + 6.25 * height - 5 * age - 161
    
    # Multiplicadores de actividad m치s precisos
    activity_multipliers = {
        "sedentary": 1.2,
        "light": 1.375,
        "moderate": 1.55,
        "active": 1.725,
        "very_active": 1.9
    }
    
    calories = bmr * activity_multipliers.get(activity.lower(), 1.55)
    
    # Ajuste por objetivo
    if goal == "weight_loss":
        calories -= 500
        meals_per_day = 5
        protein_ratio = 0.35
    elif goal == "muscle_gain":
        calories += 300
        meals_per_day = 6
        protein_ratio = 0.40
    else:  # maintenance
        meals_per_day = 4
        protein_ratio = 0.30
    
    carb_ratio = 0.45
    fat_ratio = 0.25
    
    # Lista de comidas de ejemplo seg칰n objetivo
    meal_templates = {
        "weight_loss": [
            "Desayuno: Avena con frutas y huevos (300 cal)",
            "Media ma침ana: Yogur griego con nueces (150 cal)",
            "Almuerzo: Pollo con arroz integral y vegetales (500 cal)",
            "Merienda: Fruta y queso cottage (100 cal)",
            "Cena: Pescado con ensalada (400 cal)"
        ],
        "muscle_gain": [
            "Desayuno: Tortilla de claras con avena y aguacate (500 cal)",
            "Media ma침ana: Batido de prote칤nas con pl치tano (300 cal)",
            "Almuerzo: Carne con patatas y vegetales (700 cal)",
            "Merienda: Sandwich de pollo (400 cal)",
            "Pre-entreno: Frutos secos y fruta (200 cal)",
            "Cena: Salm칩n con quinoa (600 cal)"
        ]
    }
    
    meals = meal_templates.get(goal, meal_templates["weight_loss"])
    
    return {
        "success": True,
        "data": {
            "daily_calories": round(calories),
            "macros": {
                "protein_g": round((calories * protein_ratio) / 4),
                "carbs_g": round((calories * carb_ratio) / 4),
                "fat_g": round((calories * fat_ratio) / 9)
            },
            "meals_per_day": meals_per_day,
            "goal": goal,
            "activity_level": activity,
            "sample_meals": meals,
            "recommendations": [
                f"Consume {round(calories)} calor칤as diarias",
                f"Distribuye en {meals_per_day} comidas",
                "Mantente hidratado (2-3L de agua/d칤a)",
                "Combina dieta con ejercicio regular"
            ]
        }
    }

# ================= NUEVOS ENDPOINTS (EXPANSI칍N) =================
@app.post("/profile/create")
async def create_profile(
    age: int,
    gender: str,
    height: float,
    weight: float,
    goal: str,
    activity_level: str = "moderate",
    dietary_restrictions: List[str] = [],
    allergies: List[str] = []
):
    """Crear perfil de usuario completo"""
    logger.info(f"Creando perfil para usuario: {age}a침os, {gender}")
    
    return {
        "profile_created": True,
        "profile_id": 1,
        "user_data": {
            "age": age,
            "gender": gender,
            "height_cm": height,
            "weight_kg": weight,
            "goal": goal,
            "activity_level": activity_level,
            "bmi": round(weight / ((height/100) ** 2), 1),
            "restrictions": dietary_restrictions,
            "allergies": allergies
        },
        "next": "Generar dieta personalizada en /diets/generate-advanced"
    }

@app.get("/food/search")
async def search_food(query: str, category: Optional[str] = None):
    """Buscar alimentos (simulado)"""
    # Esto se conectar칤a a una base de datos real
    food_db = {
        "pollo": {"calories": 165, "protein": 31, "carbs": 0, "fat": 3.6},
        "arroz": {"calories": 130, "protein": 2.7, "carbs": 28, "fat": 0.3},
        "manzana": {"calories": 52, "protein": 0.3, "carbs": 14, "fat": 0.2},
        "aguacate": {"calories": 160, "protein": 2, "carbs": 9, "fat": 15}
    }
    
    results = []
    for food, nutrients in food_db.items():
        if query.lower() in food.lower():
            if not category or category.lower() in food.lower():
                results.append({
                    "name": food,
                    "nutrients": nutrients,
                    "serving": "100g"
                })
    
    return {
        "query": query,
        "results": results,
        "count": len(results)
    }

@app.get("/debug/info")
async def debug_info():
    """Informaci칩n de debug"""
    return {
        "python_path": sys.path,
        "working_directory": os.getcwd(),
        "environment_vars": {k: v for k, v in os.environ.items() if "PYTHON" in k or "PATH" in k},
        "timestamp": datetime.utcnow().isoformat()
    }

# ================= INICIALIZACI칍N =================
@app.on_event("startup")
async def startup_event():
    """Evento de inicio"""
    logger.info("游 DietAI API iniciada")
    logger.info(f"游늬 Directorio: {os.getcwd()}")
    logger.info(f"游냀 Python: {sys.version}")

@app.on_event("shutdown")
async def shutdown_event():
    """Evento de apagado"""
    logger.info("游띔 DietAI API detenida")

if __name__ == "__main__":
    import uvicorn
    logger.info("Iniciando servidor...")
    uvicorn.run(app, host="0.0.0.0", port=8000, log_level="info")
